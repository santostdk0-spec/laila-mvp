<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LAILA — Assistente</title>
<meta name="theme-color" content="#001f1a" />
<style>
  :root{ --bg:#041018; --accent:#00ffd1; --panel:#07221d; --muted:#7b8a86; }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#001217 0%,#041018 100%);color:#e6fff9}
  .app{max-width:920px;margin:12px auto;display:flex;flex-direction:column;height:calc(100vh - 24px);border-radius:12px;overflow:hidden}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(0,0,0,0.18);border-bottom:1px solid rgba(255,255,255,0.03)}
  h1{font-size:20px;margin:0;color:var(--accent);letter-spacing:1px}
  #chat{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .bubble{padding:12px;border-radius:12px;max-width:78%;line-height:1.4;word-break:break-word}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .user{align-self:flex-end;background:#0b2035;color:#dff3ff;border:1px solid rgba(255,255,255,0.02)}
  .bot{align-self:flex-start;background:var(--panel);border:1px solid rgba(0,255,209,0.06);box-shadow:0 6px 22px rgba(0,255,209,0.03)}
  footer{display:flex;gap:10px;padding:14px;background:rgba(0,0,0,0.12);align-items:center}
  input[type=text]{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:#05131a;color:white}
  button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#002622;font-weight:700;cursor:pointer}
  .controls{display:flex;gap:8px;align-items:center}
  .status{font-size:13px;color:var(--muted);padding-left:8px}
  .small{font-size:12px;color:var(--muted)}
  .typing{opacity:0.8;font-style:italic}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <h1>LAILA</h1>
        <div class="small">Seu assistente privado</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div id="status" class="status">Online</div>
        <div id="mode-pill" class="small">reflexiva</div>
      </div>
    </header>

    <main id="chat"></main>

    <footer>
      <div style="display:flex;flex:1;align-items:center;gap:8px">
        <input id="input" type="text" placeholder="Fale com a Laila..." autocomplete="off" />
        <select id="mode">
          <option value="reflexiva">Reflexiva</option>
          <option value="batalha">Batalha</option>
          <option value="zueira">Zueira</option>
        </select>
        <label class="small"><input id="tts-check" type="checkbox" /> Voz</label>
      </div>
      <div>
        <button id="sendBtn">Enviar</button>
      </div>
    </footer>
  </div>

<script>
  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const modeSel = document.getElementById('mode');
  const ttsCheck = document.getElementById('tts-check');
  const statusEl = document.getElementById('status');
  const modePill = document.getElementById('mode-pill');

  function escapeHtml(s){ if(s==null) return ""; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  function addBubble(role, text, meta='') {
    const d = document.createElement('div');
    d.className = 'bubble ' + (role==='user' ? 'user' : 'bot');
    d.innerHTML = (meta ? `<div class="meta">${escapeHtml(meta)}</div>` : '') + `<div class="body">${escapeHtml(text)}</div>`;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    return d;
  }

  function typeEffectToElement(el, text, speed=14, onDone) {
    el.innerHTML = '';
    let i=0;
    const timer = setInterval(()=>{
      el.innerHTML += escapeHtml(text.charAt(i));
      i++;
      chat.scrollTop = chat.scrollHeight;
      if (i >= text.length) { clearInterval(timer); onDone && onDone(); }
    }, speed);
  }

  async function submit(){
    const text = input.value.trim();
    if (!text) return;
    modePill.innerText = modeSel.value;
    addBubble('user', text, new Date().toLocaleString());
    input.value = '';
    statusEl.innerText = 'Laila está pensando...';

    // placeholder "typing"
    const placeholder = document.createElement('div');
    placeholder.className = 'bubble bot typing';
    placeholder.innerText = 'Digitando...';
    chat.appendChild(placeholder);
    chat.scrollTop = chat.scrollHeight;

    try {
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: text, mode: modeSel.value, persist: true })
      });
      const data = await resp.json();
      placeholder.remove();

      if (data?.reply) {
        const container = document.createElement('div');
        container.className = 'bubble bot';
        container.innerHTML = `<div class="meta">${new Date().toLocaleString()}</div><div class="body"></div>`;
        chat.appendChild(container);
        chat.scrollTop = chat.scrollHeight;
        const bodyEl = container.querySelector('.body');
        typeEffectToElement(bodyEl, data.reply, 12, () => {
          if (ttsCheck.checked) speak(data.reply);
        });

        // show small debug info optionally
        if (data.retrieved_count !== undefined) {
          const info = document.createElement('div');
          info.className = 'small';
          info.style.marginTop = '6px';
          info.innerText = `Memórias recuperadas: ${data.retrieved_count} • memória salva: ${data.memory_saved ? 'sim' : 'não'}`;
          chat.appendChild(info);
        }
      } else {
        addBubble('bot', 'Erro: resposta inválida do servidor.');
        console.warn('debug', data);
      }
    } catch (e) {
      placeholder.remove();
      addBubble('bot', 'Erro de conexão com o servidor.');
      console.error(e);
    } finally {
      statusEl.innerText = 'Online';
      input.focus();
    }
  }

  sendBtn.addEventListener('click', submit);
  input.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit(); });

  // Web Speech API TTS fallback
  function speak(text) {
    if (!('speechSynthesis' in window)) return;
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'pt-BR';
    msg.rate = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(msg);
  }

  // register service worker (optional PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
</script>
</body>
</html>
